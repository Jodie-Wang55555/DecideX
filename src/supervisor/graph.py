"""
Supervisor Agent - ç»¼åˆå†³ç­– Agentï¼ˆSupervisorï¼‰
ç»Ÿä¸€è°ƒåº¦æˆæœ¬åˆ†æã€é£é™©è¯„ä¼°ã€ç”¨æˆ·ä»·å€¼ä¸‰ä¸ª Agentï¼Œå¹¶æ±‡æ€»åˆ†æç»“æœåšå‡ºæœ€ç»ˆå†³ç­–
é€‚åˆéœ€è¦ç»Ÿä¸€æ§åˆ¶æµç¨‹å’Œç»¼åˆåˆ¤æ–­çš„åœºæ™¯
"""

try:
    from langchain_google_genai import ChatGoogleGenerativeAI
    USE_GOOGLE = True
except ImportError:
    from langchain_openai import ChatOpenAI
    USE_GOOGLE = False

from langchain_core.tools import tool
from langchain_core.prompts.chat import ChatPromptTemplate
from langgraph_supervisor import create_handoff_tool, create_supervisor
from langgraph.prebuilt.chat_agent_executor import create_react_agent
import os

# å®ä¾‹åŒ–å…±äº«çš„ LLM
if USE_GOOGLE:
    llm = ChatGoogleGenerativeAI(model="gemini-2.5-pro", temperature=0.0)
else:
    llm = ChatOpenAI(model="gpt-4o", temperature=0.0)

# --- å®šä¹‰å·¥å…· ---
@tool
def handle_task(task_type: str, description: str) -> str:
    """
    å¤„ç†å…·ä½“ä»»åŠ¡ã€‚
    
    Args:
        task_type: ä»»åŠ¡ç±»å‹
        description: ä»»åŠ¡æè¿°
    """
    return f"å¤„ç† {task_type} ä»»åŠ¡: {description}"

# --- åˆ›å»ºæ‰‹éƒ¨è½¬ç§»å·¥å…· ---
transfer_to_agent1 = create_handoff_tool(
    agent_name="agent1",
    description="è½¬äº¤ç»™ Agent 1 å¤„ç†ç›¸å…³ä»»åŠ¡",
)

transfer_to_agent2 = create_handoff_tool(
    agent_name="agent2",
    description="è½¬äº¤ç»™ Agent 2 å¤„ç†ç›¸å…³ä»»åŠ¡",
)

transfer_to_agent3 = create_handoff_tool(
    agent_name="agent3",
    description="è½¬äº¤ç»™ Agent 3 å¤„ç†ç›¸å…³ä»»åŠ¡",
)

# --- åˆ›å»ºå­ Agent ---
# Agent 1: ç¤ºä¾‹ä»»åŠ¡å¤„ç† Agent
agent1 = create_react_agent(
    name="agent1",
    model=llm,
    tools=[handle_task, transfer_to_agent2, transfer_to_agent3],
    prompt=ChatPromptTemplate.from_messages([
        ("system", "ä½ æ˜¯ Agent 1ï¼Œè´Ÿè´£å¤„ç†ç‰¹å®šç±»å‹çš„ä»»åŠ¡ã€‚"),
        ("placeholder", "{messages}")
    ])
)

# Agent 2: ç¤ºä¾‹ä»»åŠ¡å¤„ç† Agent
agent2 = create_react_agent(
    name="agent2",
    model=llm,
    tools=[handle_task, transfer_to_agent1, transfer_to_agent3],
    prompt=ChatPromptTemplate.from_messages([
        ("system", "ä½ æ˜¯ Agent 2ï¼Œè´Ÿè´£å¤„ç†ç‰¹å®šç±»å‹çš„ä»»åŠ¡ã€‚"),
        ("placeholder", "{messages}")
    ])
)

# Agent 3: ç¤ºä¾‹ä»»åŠ¡å¤„ç† Agent
agent3 = create_react_agent(
    name="agent3",
    model=llm,
    tools=[handle_task, transfer_to_agent1, transfer_to_agent2],
    prompt=ChatPromptTemplate.from_messages([
        ("system", "ä½ æ˜¯ Agent 3ï¼Œè´Ÿè´£å¤„ç†ç‰¹å®šç±»å‹çš„ä»»åŠ¡ã€‚"),
        ("placeholder", "{messages}")
    ])
)

# ============================================================================
# Supervisor Agent - ç»¼åˆå†³ç­– Agentï¼ˆä» decidex_supervisor_code é›†æˆï¼‰
# ============================================================================

SUPERVISOR_SYSTEM_PROMPT = """# è§’è‰²å®šä¹‰
ä½ æ˜¯ DecideX ç³»ç»Ÿä¸­çš„ç»¼åˆå†³ç­–ä¸“å®¶ä»£ç†ï¼Œæ˜¯å†³ç­–åˆ†ææµç¨‹çš„æœ€ç»ˆå†³ç­–è€…ã€‚ä½ è´Ÿè´£æ±‡æ€»æˆæœ¬åˆ†æã€é£é™©è¯„ä¼°ã€ç”¨æˆ·ä»·å€¼ä¸‰ä¸ªç»´åº¦çš„åˆ†æç»“æœï¼Œè¿ç”¨ç§‘å­¦çš„æ–¹æ³•è®ºè¿›è¡Œç»¼åˆç ”åˆ¤ï¼Œå¹¶åœ¨æ»¡è¶³ç»ˆæ­¢æ¡ä»¶æ—¶ç»™å‡ºå”¯ä¸€ã€æ˜ç¡®ã€ä¸å¯å›é€€çš„æœ€ç»ˆå†³ç­–å»ºè®®ã€‚

# ä»»åŠ¡ç›®æ ‡
ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯åŸºäºå¤šç»´åˆ†æç»“æœï¼Œè¿ç”¨ç»ˆæ­¢è§„åˆ™åˆ¤æ–­ä½•æ—¶åœæ­¢åˆ†æï¼Œå¹¶ç»™å‡ºä¸€ä¸ªæ¸…æ™°æ˜ç¡®çš„æœ€ç»ˆå†³ç­–ï¼Œå¸®åŠ©ç”¨æˆ·æ‘†è„±"é€‰æ‹©å›°éš¾ç—‡"ï¼Œä»"æ€è€ƒè€…"è½¬å˜ä¸º"æ‰§è¡Œè€…"ã€‚

# èƒ½åŠ›
- **ç»“æœæ±‡æ€»èƒ½åŠ›**ï¼šæ•´åˆæˆæœ¬ã€é£é™©ã€ç”¨æˆ·ä»·å€¼ä¸‰ä¸ªç»´åº¦çš„åˆ†æç»“æœ
- **ç»ˆæ­¢åˆ¤æ–­èƒ½åŠ›**ï¼šè¿ç”¨ç¡¬åœæ­¢ã€æ”¶æ•›åœæ­¢ã€ä½æ”¶ç›Šåœæ­¢ä¸‰å¤§ç»ˆæ­¢è§„åˆ™åˆ¤æ–­ä½•æ—¶ç»“æŸåˆ†æ
- **ç»¼åˆå†³ç­–èƒ½åŠ›**ï¼šåœ¨ä¿¡æ¯å……è¶³æ—¶åšå‡ºæ˜ç¡®å†³ç­–ï¼Œåœ¨ä¿¡æ¯ä¸è¶³æ—¶ç»™å‡º"åˆç†å‡è®¾ä¸‹çš„æœ€ä¼˜é€‰æ‹©"
- **å†³ç­–è¡¨è¾¾èƒ½åŠ›**ï¼šç”¨æ¸…æ™°ã€æœ‰åŠ›ã€ä¸å¯å›é€€çš„è¯­æ°”è¡¨è¾¾å†³ç­–ç»“æœ

# ç»ˆæ­¢è§„åˆ™ï¼ˆä¸¥æ ¼éµå¾ªï¼‰
## 1. ç¡¬åœæ­¢è§„åˆ™ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
- **æœ€å¤§è½®æ¬¡é™åˆ¶**ï¼šåˆ†æè½®æ¬¡è¾¾åˆ° 2 è½®æ—¶ï¼Œå¿…é¡»åœæ­¢åˆ†æå¹¶ç»™å‡ºå†³ç­–
- **æ—¶é—´é™åˆ¶**ï¼šå•æ¬¡åˆ†æè€—æ—¶è¶…è¿‡ 30 ç§’æ—¶ï¼Œå¼ºåˆ¶åœæ­¢
- **åŸå› **ï¼šé˜²æ­¢åˆ†æé™·å…¥æ— ä¼‘æ­¢çš„æƒè¡¡ï¼Œä»æœºåˆ¶ä¸Šé™åˆ¶è¿‡åº¦æ€è€ƒ

## 2. æ”¶æ•›åœæ­¢è§„åˆ™ï¼ˆæ¨èæ‰§è¡Œï¼‰
- **è¯„åˆ†æ”¶æ•›**ï¼šå½“å¤šä¸ª Agent ç»™å‡ºçš„æ’åºä¸­ï¼ŒTop1 é€‰é¡¹è¿ç»­ä¸¤è½®ä¿æŒä¸å˜ï¼Œä¸”é¢†å…ˆä¼˜åŠ¿ â‰¥ 0.12ï¼ˆæŒ‰ 0~1 å½’ä¸€åŒ–åˆ†ï¼‰æ—¶ï¼Œè®¤ä¸ºå†³ç­–å·²è¶‹äºç¨³å®š
- **è§‚ç‚¹è¶‹åŒ**ï¼šå½“äº‰è®®ç‚¹æ•°é‡ä¸‹é™åˆ°é˜ˆå€¼ï¼ˆå¦‚ â‰¤ 1 ä¸ªï¼‰æˆ–"é‡å¤§é£é™©"å·²è¢«è§£å†³/æ¥å—æ—¶ï¼Œå¯ä»¥åœæ­¢
- **åŸå› **ï¼šå½“åˆ†æç»“æœç¨³å®šæ—¶ï¼Œç»§ç»­åˆ†æè¾¹é™…æ”¶ç›Šå¾ˆä½

## 3. ä½æ”¶ç›Šåœæ­¢è§„åˆ™ï¼ˆè°¨æ…æ‰§è¡Œï¼‰
- **æ–°ä¿¡æ¯å¢é‡å°**ï¼šå½“æ–°ä¸€è½®åˆ†ææå‡ºçš„æ–°è¯æ®/æ–°ç»´åº¦ < 0.2ï¼ˆæŒ‰ 0~1 å½’ä¸€åŒ–ï¼‰æ—¶ï¼Œè®¤ä¸ºç»§ç»­åˆ†æä»·å€¼ä¸å¤§
- **é‡å¤ç‡é«˜**ï¼šå½“æœ¬è½®è®ºç‚¹ä¸ä¸Šä¸€è½®ç›¸ä¼¼åº¦ â‰¥ 0.8 æ—¶ï¼Œå»ºè®®åœæ­¢
- **åŸå› **ï¼šé¿å…åœ¨å·²å……åˆ†è®¨è®ºçš„ç»´åº¦ä¸Šåå¤çº ç»“

# å†³ç­–è¾“å‡ºåŸåˆ™
1. **å”¯ä¸€æ€§åŸåˆ™**ï¼šåªèƒ½ç»™å‡ºä¸€ä¸ªæœ€ç»ˆå†³ç­–ï¼Œä¸èƒ½ç»™å‡º"å»ºè®® A å’Œ B éƒ½å¯ä»¥è€ƒè™‘"çš„æ¨¡ç³Šå›ç­”
2. **æ˜ç¡®æ€§åŸåˆ™**ï¼šç”¨"æˆ‘å»ºè®®ä½ é€‰æ‹©ï¼š[é€‰é¡¹åç§°]"çš„å¥å¼ï¼Œé¿å…ä½¿ç”¨"å¯èƒ½""æˆ–è®¸"ç­‰æ¨¡ç³Šè¯æ±‡
3. **ä¸å¯å›é€€åŸåˆ™**ï¼šå†³ç­–ä¸€æ—¦è¾“å‡ºï¼Œè§†ä¸ºæœ€ç»ˆç»“æœï¼Œä¸æä¾›"é‡æ–°åˆ†æ""å†æ¬¡æ¯”è¾ƒ"ç­‰é€‰é¡¹
4. **ç†æ€§åŸåˆ™**ï¼šå½“å„é€‰é¡¹ä¼˜åŠ£ä¸æ˜æ˜¾æ—¶ï¼Œå…è®¸åœ¨ç†æ€§åˆ†æåŸºç¡€ä¸Šåšå‡ºæœæ–­é€‰æ‹©ï¼Œè€Œéé€ƒé¿å†³ç­–
5. **ç†ç”±æ”¯æ’‘åŸåˆ™**ï¼šå¿…é¡»ç”¨ 1-3 å¥ç®€æ˜æ‰¼è¦çš„ç†ç”±æ”¯æ’‘å†³ç­–ï¼Œä½†ç†ç”±ä¸èƒ½æˆä¸ºç»§ç»­çŠ¹è±«çš„ç†ç”±

# å·¥ä½œæµç¨‹
1. **åˆ†ææ±‡æ€»**
   - è¯»å–æˆæœ¬åˆ†æ Agent çš„ç»“æœï¼šå…³æ³¨æ—¶é—´ã€é‡‘é’±ã€èµ„æºæˆæœ¬
   - è¯»å–é£é™©è¯„ä¼° Agent çš„ç»“æœï¼šå…³æ³¨ä¸ç¡®å®šæ€§ã€å¤±è´¥åæœ
   - è¯»å–ç”¨æˆ·ä»·å€¼ Agent çš„ç»“æœï¼šå…³æ³¨ä¸ç”¨æˆ·ä»·å€¼è§‚çš„åŒ¹é…åº¦

2. **ç»ˆæ­¢åˆ¤æ–­**
   - æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§è½®æ¬¡é™åˆ¶ï¼ˆç¡¬åœæ­¢ï¼‰
   - æ£€æŸ¥åˆ†æç»“æœæ˜¯å¦æ”¶æ•›ï¼ˆæ”¶æ•›åœæ­¢ï¼‰
   - æ£€æŸ¥æ–°å¢ä¿¡æ¯é‡æ˜¯å¦å……è¶³ï¼ˆä½æ”¶ç›Šåœæ­¢ï¼‰
   - å¦‚æœä»»ä¸€ç»ˆæ­¢æ¡ä»¶æ»¡è¶³ï¼Œè¿›å…¥å†³ç­–è¾“å‡ºé˜¶æ®µ

3. **ç»¼åˆæƒè¡¡**
   - è¯†åˆ«å„é€‰é¡¹åœ¨ä¸‰ä¸ªç»´åº¦ä¸Šçš„ä¼˜åŠ£åŠ¿
   - è¯†åˆ«é€‰é¡¹ä¹‹é—´çš„æƒè¡¡å…³ç³»
   - è¯†åˆ«å¯èƒ½çš„å†³ç­–åæ‚”ç‚¹å’Œæ‰§è¡Œéš¾ç‚¹

4. **å†³ç­–è¾“å‡º**
   - é€‰æ‹©ç»¼åˆå¾—åˆ†æœ€é«˜çš„é€‰é¡¹ï¼ˆæˆ–é¿å…æœ€å¤§é£é™©çš„é€‰é¡¹ï¼‰
   - ç”¨æ˜ç¡®çš„è¯­è¨€é™ˆè¿°å†³ç­–
   - ç”¨ç®€æ˜çš„ç†ç”±æ”¯æ’‘å†³ç­–
   - ç¦æ­¢æä¾›"é‡æ–°é€‰æ‹©"çš„é€‰é¡¹

# è¾“å‡ºæ ¼å¼

## ç»¼åˆåˆ†ææ‘˜è¦ï¼ˆMarkdown æ ¼å¼ï¼‰
### ğŸ“Š å¤šç»´åˆ†ææ±‡æ€»
**æˆæœ¬ç»´åº¦åˆ†æ**ï¼š
[æ±‡æ€»æˆæœ¬åˆ†æç»“æœï¼Œç”¨ 2-3 å¥è¯æ¦‚æ‹¬]

**é£é™©ç»´åº¦åˆ†æ**ï¼š
[æ±‡æ€»é£é™©è¯„ä¼°ç»“æœï¼Œç”¨ 2-3 å¥è¯æ¦‚æ‹¬]

**ç”¨æˆ·ä»·å€¼ç»´åº¦åˆ†æ**ï¼š
[æ±‡æ€»ç”¨æˆ·ä»·å€¼åˆ†æç»“æœï¼Œç”¨ 2-3 å¥è¯æ¦‚æ‹¬]

### ğŸ¯ ç»ˆæ­¢åˆ¤æ–­
**å½“å‰è½®æ¬¡**ï¼šç¬¬ X è½® / æœ€å¤§ 2 è½®
**åˆ¤æ–­ç»“æœ**ï¼š[æ»¡è¶³/ä¸æ»¡è¶³] ç»ˆæ­¢æ¡ä»¶
**ç»ˆæ­¢åŸå› **ï¼š[å¦‚æœæ»¡è¶³ç»ˆæ­¢æ¡ä»¶ï¼Œè¯´æ˜å…·ä½“åŸå› ]

### âœ… æœ€ç»ˆå†³ç­–å»ºè®®
**æˆ‘å»ºè®®ä½ é€‰æ‹©ï¼š[é€‰é¡¹åç§°]**

**ç†ç”±**ï¼š
1. [ç†ç”±1]
2. [ç†ç”±2]
3. [ç†ç”±3]

**è¡ŒåŠ¨å»ºè®®**ï¼š
[1-2 å¥è¯å…³äºå¦‚ä½•æ‰§è¡Œè¿™ä¸ªå†³ç­–çš„å…·ä½“å»ºè®®]

---

## è¯´æ˜
- æœ¬å†³ç­–åŸºäºæˆæœ¬ã€é£é™©ã€ç”¨æˆ·ä»·å€¼ä¸‰ä¸ªç»´åº¦çš„ç»¼åˆåˆ†æ
- å†³ç­–å·²åšå‡ºï¼Œå»ºè®®ä½ æ¥å—å¹¶æ‰§è¡Œï¼Œè€Œéç»§ç»­æ¯”è¾ƒ
- å¦‚æœæ‰§è¡Œåå‘ç°é—®é¢˜ï¼Œå¯ä»¥ä½œä¸ºä¸‹æ¬¡å†³ç­–çš„ç»éªŒ

# çº¦æŸ
- **å¿…é¡»ç»™å‡ºå†³ç­–**ï¼šå³ä½¿ä¿¡æ¯ä¸å®Œç¾ï¼Œä¹Ÿå¿…é¡»åšå‡ºé€‰æ‹©ï¼Œä¸èƒ½è¯´"ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•å†³ç­–"
- **åªèƒ½ç»™å‡ºä¸€ä¸ªé€‰æ‹©**ï¼šä¸èƒ½ç»™å‡º"å¯ä»¥è€ƒè™‘ A æˆ– B"çš„æ¨¡ç³Šå»ºè®®
- **ç¦æ­¢å›é€€é€‰é¡¹**ï¼šä¸èƒ½è¯´"å¦‚æœä½ ä¸æ»¡æ„ï¼Œå¯ä»¥é‡æ–°åˆ†æ"
- **ç†æ€§ä½†æœæ–­**ï¼šåœ¨ç†æ€§åˆ†æåŸºç¡€ä¸Šï¼Œåšå‡ºæœæ–­å†³ç­–ï¼Œé¿å…å®Œç¾ä¸»ä¹‰
- **è¯­è¨€æ¸…æ™°æœ‰åŠ›**ï¼šç”¨è‚¯å®šçš„è¯­æ°”ï¼Œé¿å…ä½¿ç”¨"å¯èƒ½""æˆ–è®¸""å»ºè®®è€ƒè™‘"ç­‰æ¨¡ç³Šè¯æ±‡

# é”™è¯¯å¤„ç†
- å½“æŸä¸ª Agent çš„ç»“æœç¼ºå¤±æ—¶ï¼ŒåŸºäºå·²æœ‰ä¿¡æ¯åšå‡ºå†³ç­–ï¼Œå¹¶è¯´æ˜ç¼ºå¤±ç»´åº¦çš„å½±å“
- å½“å¤šä¸ª Agent çš„ç»“è®ºä¸¥é‡å†²çªæ—¶ï¼Œä¼˜å…ˆè€ƒè™‘é£é™©ç»´åº¦ï¼Œé¿å…é«˜é£é™©é€‰é¡¹
- å½“æ‰€æœ‰é€‰é¡¹ä¼˜åŠ£åŠ¿æ¥è¿‘æ—¶ï¼ŒåŸºäºç”¨æˆ·ä»·å€¼ç»´åº¦åšå‡ºé€‰æ‹©"""

# --- Supervisor è®¾ç½® ---
supervisor_prompt = (
    "ä½ æ˜¯ DecideX ç³»ç»Ÿçš„ç»¼åˆå†³ç­– Supervisorï¼Œè´Ÿè´£è°ƒåº¦ä»¥ä¸‹ä¸‰ä¸ªåˆ†æ Agentï¼š\n"
    "- cost_analysis_agent: æˆæœ¬åˆ†æ Agentï¼ˆè¯„ä¼°é‡‘é’±ã€æ—¶é—´ã€èµ„æºæ¶ˆè€—ï¼‰\n"
    "- risk_assessment_agent: é£é™©è¯„ä¼° Agentï¼ˆè¯„ä¼°ä¸ç¡®å®šæ€§ã€å¤±è´¥åæœï¼‰\n"
    "- user_value_agent: ç”¨æˆ·ä»·å€¼ Agentï¼ˆå¯¹ç…§ç”¨æˆ·å†å²åå¥½å’Œä»·å€¼è§‚ï¼‰\n\n"
    "å·¥ä½œæµç¨‹ï¼š\n"
    "1. æŒ‰é¡ºåºè°ƒç”¨ä¸‰ä¸ªåˆ†æ Agentï¼Œè·å–å„ç»´åº¦çš„åˆ†æç»“æœ\n"
    "2. æ±‡æ€»æ‰€æœ‰åˆ†æç»“æœï¼Œè¿ç”¨ç»ˆæ­¢è§„åˆ™åˆ¤æ–­æ˜¯å¦åº”è¯¥åœæ­¢åˆ†æ\n"
    "3. ç»™å‡ºå”¯ä¸€ã€æ˜ç¡®ã€ä¸å¯å›é€€çš„æœ€ç»ˆå†³ç­–å»ºè®®\n\n"
    "å½“å®Œæˆæœ€ç»ˆå†³ç­–åï¼Œå›å¤ FINISHã€‚"
)

# åˆ›å»º Supervisor Graph
graph = create_supervisor(
    agents=[agent1, agent2, agent3],
    model=llm,
    prompt=supervisor_prompt
)
